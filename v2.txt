<?php
/**
 * Plugin Name: VapeVida Flavorshot Recommender Quiz
 * Description: Product Recommendation Quiz for Flavorshots, which automatically filters populated Global Access Attributes. Requires pa_geuseis and pa_quiz-ingredient, which get automatically created, if missing.
 * Version: 0.6 
 * Author: Panagiotis Drougas / VapeVida
 * VersionNotes: Asterisk on Required fields and Custom border styling.
 */

if ( ! defined( 'ABSPATH' ) ) exit; // Exit if accessed directly
if ( is_admin() ) {
    require_once( ABSPATH . 'wp-admin/includes/file.php' );
}

// --- 1. Shortcode Function: Loads the Form and Populates Selects (FINAL DYNAMIC VERSION) ---
function vv_recommender_quiz_shortcode() {
    ob_start();

    // --- DYNAMICALLY LOAD SAVED SETTINGS ---
    // Get all settings stored under the 'vv_quiz_settings' option name
    $settings = get_option( 'vv_quiz_settings' );
    
    // Checkbox status: Enable/Disable Secondary Ingredient field (Default to false/hidden if not set)
    $show_third_field = isset( $settings['field_status'] ) && $settings['field_status'];

    // Placeholders (Default to Greek if not set by admin)
    $placeholder_primary = isset( $settings['placeholder_primary'] ) ? esc_attr($settings['placeholder_primary']) : '-- Επιλέξτε Βασικό Συστατικό --';
    $placeholder_secondary = isset( $settings['placeholder_secondary'] ) ? esc_attr($settings['placeholder_secondary']) : '-- Επιλέξτε Δευτερεύον Συστατικό --';

    // --- TAXONOMY SLUGS ---
    $type_taxonomy_slug = 'pa_geuseis';      
    $ingredient_taxonomy_slug = 'pa_quiz-ingredient'; 

    // Get Shop URL
    $shop_url = get_permalink( wc_get_page_id( 'shop' ) );

    // Dynamically fetch all active terms
    $flavor_type_terms = get_terms( array(
        'taxonomy'   => $type_taxonomy_slug,
        'hide_empty' => true, 
    ) );
    
    $ingredient_terms = get_terms( array(
        'taxonomy'   => $ingredient_taxonomy_slug,
        'hide_empty' => true,
    ) );
    
    // Safety Check
    if ( is_wp_error( $flavor_type_terms ) || is_wp_error( $ingredient_terms ) || empty( $flavor_type_terms ) ) {
        // Only return the error message if the core data cannot be fetched
        return '<p style="color: red;">[Σφάλμα Φόρτωσης]: Βεβαιωθείτε ότι τα Global Attributes (geuseis & quiz-ingredient) έχουν όρους και προϊόντα αντιστοιχισμένα.</p>';
    }
    ?>

    <div class="vv-quiz-container">
        <h2>Βρες το Ιδανικό Υγρό!</h2>
        <p>Επίλεξε το προφίλ γεύσης και τα συστατικά που προτιμάς.</p>

        <form method="get" action="<?php echo esc_url( $shop_url ); ?>" id="vv-recommender-form">
            
            <input type="hidden" name="filter_applied" value="1">
            
            <div class="vv-select-row">

                <div class="vv-select-col">
                    <label for="flavor_type" required>1. Προφίλ Υγρού:</label>
                    <select name="filter_geuseis" id="flavor_type" required>
                        <option value="">-- Επιλέξτε Προφίλ --</option>
                        <?php 
                        foreach ( $flavor_type_terms as $term ) {
                            echo '<option value="' . esc_attr( $term->slug ) . '">' . esc_html( $term->name ) . '</option>';
                        }
                        ?>
                    </select>
                </div>
                
                <div class="vv-select-col">
                    <label for="flavor_ingredient" required>2. Βασικό Συστατικό:</label>
                    <select name="filter_quiz-ingredient" id="flavor_ingredient" required>
                        <option value=""><?php echo $placeholder_primary; ?></option>
                        <?php 
                        foreach ( $ingredient_terms as $term ) {
                            echo '<option value="' . esc_attr( $term->slug ) . '">' . esc_html( $term->name ) . '</option>';
                        }
                        ?>
                    </select>
                </div>

                <?php if ( $show_third_field ) : ?>
                <div class="vv-select-col">
                    <label for="flavor_ingredient_optional">3. Δευτερεύον Συστατικό:</label>
                    <select name="filter_quiz-ingredient-optional" id="flavor_ingredient_optional">
                        <option value=""><?php echo $placeholder_secondary; ?></option>
                        <?php 
                        foreach ( $ingredient_terms as $term ) {
                            echo '<option value="' . esc_attr( $term->slug ) . '">' . esc_html( $term->name ) . '</option>';
                        }
                        ?>
                    </select>
                </div>
                <?php endif; ?>
                
            </div> 
            
            <button type="submit" class="button">ΒΡΕΣ ΤΟ ΥΓΡΟ ΣΟΥ</button>
        </form>

    </div>
    
    <style>
        /* ... (Your full CSS style block remains the same here) ... */
        /* BASE STYLING (Mobile/Tablet Default) */
        .vv-quiz-container { 
            /* FIXED: Use 90% width for mobile screens */
            width: 90%; /* Changed from 100% to 90% for better mobile margin */
            max-width: 1200px; /* Limits size on ultra-wide screens */
            margin: 0 auto; /* Centers the container */
            padding: 20px; 
            border-radius: 5px; 
            box-sizing: border-box; /* Ensures padding is included in the 90% width */
        }
        .vv-quiz-container h2, .vv-quiz-container p { text-align: center; }
        
        /* Mobile Stacked Layout (The default) */
        .vv-select-row { 
            display: block; 
        }
        .vv-select-col { 
            margin-bottom: 15px; 
        }

        /* Generic styles for all form elements */
        .vv-quiz-container label { display: block; margin-top: 5px; font-weight: bold; }
        .vv-quiz-container select { width: 100%; padding: 10px; margin-top: 5px; box-sizing: border-box; }
        
        /* Button Style */
        .vv-quiz-container button { 
            width: 100%; 
            padding: 10px; 
            margin-top: 20px; 
            background-color: #e21e51; /* Custom Color */
            color: white; 
            border: none; 
            cursor: pointer; 
            display: block; 
            font-size: 16px;
        }

        /* Required Field Asterisk */
        .vv-quiz-container label[required]:after {
            content: " *"; /* Add a space and the asterisk */
            color: #d9534f; /* A standard error red color */
            font-weight: bold;
        }

        /* Highlight border of invalid fields (Optional, but highly recommended) */
        .vv-quiz-container select:invalid:required {
            border-color: #d9534f;
            box-shadow: 0 0 5px rgba(217, 83, 79, 0.5);
        }


        /* --- DESKTOP STYLING (Applies when screen width is >= 768px) --- */
        @media (min-width: 768px) {
            
            /* FORCE FLEXBOX on the container */
            .vv-quiz-container .vv-select-row {
                display: flex !important; 
                gap: 20px; 
                align-items: flex-start; 
                margin-bottom: 20px; 
            }
            
            /* Ensure all columns share space equally */
            .vv-quiz-container .vv-select-col {
                flex: 1 1 0; 
                min-width: 0; 
                margin-bottom: 0; 
            }

            /* Re-center the button for desktop */
            .vv-quiz-container button {
                 max-width: 300px; 
                 margin: 20px auto 0; 
                 display: block;
            }
        }
    </style>
    <?php
    return ob_get_clean();
}
// You must ensure this hook is still present in your file:
add_shortcode( 'vapevida_quiz', 'vv_recommender_quiz_shortcode' );

// --- 2. Automated Attribute Creation (Kept for completeness) ---
function vv_create_recommender_attributes() {
    if ( ! function_exists( 'wc_create_attribute' ) ) return;

    $attributes = [
        'geuseis'           => 'Τύπος Γεύσης',      
        'quiz-ingredient'   => 'Συστατικό (Quiz)',         
    ];

    foreach ( $attributes as $name => $label ) {
        if ( ! taxonomy_exists( 'pa_' . $name ) ) {
            wc_create_attribute( [
                'name'         => $label,
                'slug'         => $name,
                'type'         => 'select',
                'orderby'      => 'menu_order',
                'has_archives' => true,
            ] );
        }
    }
}
add_action( 'init', 'vv_create_recommender_attributes' );

// --- START: Custom Query Logic to Force AND for Three Filters ---

add_action( 'woocommerce_product_query', 'vv_custom_three_filter_query', 20 );

/**
 * Intercepts the WooCommerce product query to apply AND logic for all three quiz fields.
 *
 * @param WP_Query $query The WooCommerce product query object.
 */
function vv_custom_three_filter_query( $query ) {
    // 1. Check if the query is the main product loop and if the form was submitted
    if ( is_admin() || ! $query->is_main_query() || ! is_post_type_archive('product') ) {
        return;
    }
    
    // Check for the hidden input field to ensure the request came from the quiz form
    if ( ! isset( $_GET['filter_applied'] ) ) {
        return;
    }

    // 2. Get and sanitize all three attribute values from the URL
    $type_term = isset( $_GET['filter_geuseis'] ) ? sanitize_text_field( $_GET['filter_geuseis'] ) : '';
    $primary_ingredient = isset( $_GET['filter_quiz-ingredient'] ) ? sanitize_text_field( $_GET['filter_quiz-ingredient'] ) : '';
    $secondary_ingredient = isset( $_GET['filter_quiz-ingredient-optional'] ) ? sanitize_text_field( $_GET['filter_quiz-ingredient-optional'] ) : '';

    
    $filters_applied = false;
    
    // --- Collect ALL terms that need to be queried ---
    $new_tax_query = array();
    
    // --- Filter 1: Type (pa_geuseis) ---
    if ( ! empty( $type_term ) ) {
        $new_tax_query[] = array(
            'taxonomy' => 'pa_geuseis', // The Type Attribute Taxonomy
            'field'    => 'slug',
            'terms'    => array( $type_term ),
            'operator' => 'IN',
        );
        $filters_applied = true;
    }

    // --- Filters 2 & 3: Combined Ingredient Logic ---
    $all_ingredients = array_filter( array( $primary_ingredient, $secondary_ingredient ) );
    
    if ( ! empty( $all_ingredients ) ) {
        
        // Add the combined, strict AND query for the ingredients
        $new_tax_query[] = array(
            'taxonomy' => 'pa_quiz-ingredient', 
            'field'    => 'slug',
            'terms'    => $all_ingredients,
            'operator' => 'AND', // FORCE the product to have ALL selected ingredients
        );
        $filters_applied = true;
    }

    // 4. Apply the final tax_query
    if ( $filters_applied ) {
        // Set the relation explicitly for the new queries we built
        $new_tax_query['relation'] = 'AND';
        
        // Get the current tax query (from the query object)
        $current_tax_query = $query->get('tax_query');

        // Check if WooCommerce already has any tax queries set
        if ( ! empty( $current_tax_query ) && is_array($current_tax_query) ) {
            // Ensure any existing filters are also ANDed
            // We only need to set the relation if we merge them, but for safety, we assume we merge.
            
            // Check if the first element is a relation string or an array (to prevent the fatal error)
            if ( isset($current_tax_query['relation']) ) {
                 // If a relation is already set, we combine our new query with the existing query.
                 $merged_tax_query = array_merge( $current_tax_query, $new_tax_query );
            } else {
                // If it's just a set of arrays, we wrap it in a new AND array and merge.
                $merged_tax_query = array_merge( $current_tax_query, $new_tax_query );
                $merged_tax_query['relation'] = 'AND';
            }

        } else {
            // If no existing filters, just use ours
            $merged_tax_query = $new_tax_query;
        }

        // Final application of the merged query
        $query->set( 'tax_query', $merged_tax_query );
    }
}

// --- 5. Add Admin Menu Page (Details/Info Page) ---
function vv_add_plugin_admin_page() {
    // Use add_menu_page() to create a new top-level item on the main sidebar
    add_menu_page(
        'VapeVida Quiz Details',               // 1. Page Title
        'VapeVida Quiz',                       // 2. Menu Title (What appears in the sidebar)
        'manage_options',                      // 3. Capability required
        'vapevida-quiz-details',               // 4. Unique Menu Slug (The URL identifier)
        'vv_render_details_page',              // 5. Function that renders the page content
        'dashicons-clipboard',                 // 6. Icon URL or Dashicon class 
        70                                     // 7. Position (e.g., 70 places it 'Users')
    );
}
add_action( 'admin_menu', 'vv_add_plugin_admin_page' );


// --- 6. PHP: Render the Admin Page Content (FINAL CORRECTED STRUCTURE) ---
function vv_render_details_page() {
    $shop_url = get_permalink( wc_get_page_id( 'shop' ) );

    // 1. Καθορισμός Headers
    $all_headers = array(
        'Version'      => 'Version',
        'Author'       => 'Author',
        'VersionNotes' => 'VersionNotes', 
    );
    
    // 2. Ανάκτηση δεδομένων (πρέπει να εκτελεστεί σωστά τώρα που το file.php φορτώνεται νωρίτερα)
    $plugin_data_raw = get_file_data( __FILE__, $all_headers, 'plugin' );
    
    // 3. Ασφαλής ανάθεση τιμών
    $plugin_version = 'N/A';
    $plugin_author = 'Unknown';
    $version_notes = 'No notes provided.';

    if ( $plugin_data_raw ) {
        $plugin_version = esc_html($plugin_data_raw['Version']);
        $plugin_author = esc_html($plugin_data_raw['Author']);
        $version_notes = esc_html($plugin_data_raw['VersionNotes']);
    }
    
    ?>
    <div class="wrap">
        <h1>VapeVida Flavorshot Recommender Quiz</h1>
        <p class="about-text">Οδηγίες χρήσης και τεχνικές πληροφορίες για τη διαχείριση του custom plugin.</p>
        
        <hr class="wp-header-end">

        <div id="vv-admin-content" style="display: flex; gap: 30px; margin-top: 20px;">
            
            <div id="vv-main-content-wrapper" style="flex: 2; min-width: 0;"> 
                
                <div id="vv-settings-form" class="postbox" style="margin-bottom: 20px;">
                    <h2 class="hndle"><span><span class="dashicons dashicons-forms"></span> Ρυθμίσεις Quiz</span></h2>
                    <div class="inside">
                        <form method="post" action="options.php">
                            <?php 
                            settings_fields( 'vv_quiz_options_group' );
                            do_settings_sections( 'vapevida-quiz-details' );
                            submit_button();
                            ?>
                        </form>
                    </div>
                </div>
                
                <div id="vv-main-instructions" class="postbox">
                    <h2 class="hndle"><span>Οδηγίες Χρήσης & Συντήρηση</span></h2>
                    <div class="inside">
                        <p>Αυτό το plugin λειτουργεί ως ένας **Γρήγορος Οδηγός Προϊόντων** (Product Finder) και βασίζεται σε φίλτρα URL για την άμεση εύρεση υγρών από τον πελάτη.</p>
                        
                        <h3><span class="dashicons dashicons-admin-home"></span> Κωδικός Εμφάνισης (Shortcode)</h3>
                        <code style="display: block; padding: 10px; margin-bottom: 20px; background: #f0f0f0; border: 1px dashed #ccc; font-weight: bold;">[vapevida_quiz]</code>
                        
                        <h3><span class="dashicons dashicons-editor-ul"></span> Οδηγός Διαχείρισης Γεύσεων</h3>
                        <p style="margin-bottom: 15px;">Η προσθήκη, αφαίρεση ή ενημέρωση των διαθέσιμων Γεύσεων (Συστατικών) γίνεται <strong>αποκλειστικά</strong> μέσω του WooCommerce. Το Quiz φορτώνει τα δεδομένα <strong>δυναμικά</strong>.</p>

                        <div style="background: #eef7ff; padding: 15px; border: 1px solid #cceeff; border-radius: 5px;">
                            <p style="font-weight: bold; margin-top: 0;">Βήμα 1: Πρόσβαση στο Attribute</p>
                            <p style="margin-left: 10px;">Πηγαίνετε: <strong>Προϊόντα &rarr; Χαρακτηριστικά</strong>. Βρείτε το Attribute με το όνομα <code> Συστατικό (Quiz) </code> (slug: <code>pa_quiz-ingredient</code>).</p>
                        </div>
                        
                        <div style="background: #eef7ff; padding: 15px; border: 1px solid #cceeff; border-radius: 5px; margin-top: 10px;">
                            <p style="font-weight: bold; margin-top: 0;">Βήμα 2: Προσθήκη / Επεξεργασία Συστατικού</p>
                            <ul style="margin-left: 10px; padding-left: 15px; list-style-type: square;">
                                <li><strong>Για Προσθήκη:</strong> Προσθέστε τον νέο Όρο (Term) με το όνομα της γεύσης (π.χ. 'Kiwi') και ένα καθαρό slug (π.χ. 'kiwi') με το πρόθεμα <code>q-</code>.</li>
                                <li><strong>Για Επεξεργασία:</strong> Επεξεργαστείτε έναν υπάρχοντα Όρο.</li>
                            </ul>
                        </div>
                        
                        <div style="background: #eef7ff; padding: 15px; border: 1px solid #cceeff; border-radius: 5px; margin-top: 10px;">
                            <p style="font-weight: bold; margin-top: 0;">Βήμα 3: Σύνδεση με Προϊόν</p>
                            <p style="margin-left: 10px;">Ανοίξτε το προϊόν που περιέχει τη νέα γεύση. Στην καρτέλα 'Attributes', βεβαιωθείτε ότι έχετε αντιστοιχίσει τον Όρο στο <code>Συστατικό (Quiz)</code>.</p>
                            <p style="margin-left: 10px; color: #d9534f; font-weight: bold;">
                                <span class="dashicons dashicons-warning" style="font-size: 1.2em; vertical-align: middle;"></span> Σημαντικό: Ένας Όρος εμφανίζεται στο Quiz **ΜΟΝΟ** αν έχει τουλάχιστον ένα δημοσιευμένο προϊόν αντιστοιχισμένο.
                            </p>
                        </div>

                        <h3 style="margin-top: 30px;"><span class="dashicons dashicons-search"></span> Τεχνική Λογική Φίλτρου</h3>
                        <p>Ο κώδικας Query Logic εξασφαλίζει ότι το φιλτράρισμα γίνεται με **απόλυτη ακρίβεια** (AND Logic) ανάμεσα σε όλα τα επιλεγμένα πεδία.</p>
                        <div style="background: #f7f7f7; padding: 15px; border-left: 4px solid #e21e51; margin-top: 15px;">
                            <p><strong>&bull; Τύπος Γεύσης:</strong> `filter_geuseis` (Single Select)</p>
                            <p><strong>&bull; Βασικό & Δευτερεύον Συστατικό:</strong> `filter_quiz-ingredient` (Combined AND Logic)</p>
                            <p style="margin-top: 10px; font-style: italic;">Το σύστημα ελέγχει αν το προϊόν έχει το 'Τύπος Γεύσης' **ΚΑΙ** και τα δύο επιλεγμένα 'Συστατικά' ταυτόχρονα.</p>
                        </div>
                        </div>
                </div>
            </div> <div id="vv-sidebar-metadata" class="postbox-container" style="flex: 1; min-width: 300px;">
                <div class="postbox">
                    <h2 class="hndle"><span><span class="dashicons dashicons-clipboard" style="font-size: 1.2em; vertical-align: middle;"></span> Πληροφορίες Plugin</span></h2>
                    <div class="inside">
                        <ul style="list-style: none; padding: 0; margin: 0;">
                            <li style="margin-bottom: 8px;"><strong>Συντάκτης:</strong> <span style="font-weight: bold;"><?php echo esc_html($plugin_author); ?></span></li>
                            <li style="margin-bottom: 8px;"><strong>Έκδοση Plugin:</strong> <?php echo esc_html($plugin_version); ?></li>
                            <li style="margin-bottom: 12px;"><strong>Version Notes:</strong> <em><?php echo esc_html($version_notes); ?></em></li> 
                            
                            <li style="border-top: 1px solid #eee; padding-top: 12px;"><strong>URL Καταστήματος:</strong> <a href="<?php echo esc_url($shop_url); ?>" target="_blank">Άνοιγμα Καταστήματος</a></li>
                        </ul>
                        
                        <h3 style="margin-top: 20px;">Slugs Χαρακτηριστικών</h3>
                        <p>Τα απαραίτητα Global Attributes για το Quiz είναι:</p>
                        <ul style="padding-left: 20px;">
                            <li>**Τύπος Γεύσης:** <code>pa_geuseis</code></li>
                            <li>**Συστατικό:** <code>pa_quiz-ingredient</code></li>
                        </ul>
                    </div>
                </div>
            </div> </div>
    </div>
    <?php
}
// --- 7. Add Settings Link to Plugins Page ---
add_filter( 'plugin_action_links_' . plugin_basename( __FILE__ ), 'vv_add_plugin_action_links' );

/**
 * Adds a "Settings" link directly beneath the plugin name on the Plugins page.
 *
 * @param array $actions Array of plugin action links.
 * @return array Modified array of plugin action links.
 */
function vv_add_plugin_action_links( $actions ) {
    // 1. Define the URL for your custom admin page.
    // The slug 'vapevida-quiz-details' matches the one used in add_menu_page().
    $settings_link = '<a href="admin.php?page=vapevida-quiz-details">' . __( 'Quiz Info & Help', 'vapevida-quiz' ) . '</a>';
    
    // 2. Add the link to the beginning of the links array.
    array_unshift( $actions, $settings_link );

    return $actions;
}

// --- 8. Register Settings Fields ---
function vv_quiz_register_settings() {
    // Register the setting group
    register_setting( 'vv_quiz_options_group', 'vv_quiz_settings' );

    // Add a settings section
    add_settings_section(
        'vv_quiz_main_section',
        'Ρυθμίσεις Φόρμας και Πεδίων',
        'vv_quiz_main_section_callback',
        'vapevida-quiz-details'
    );

    // 1. Field Status: Enable/Disable Secondary Ingredient
    add_settings_field(
        'field_status',
        'Ενεργοποίηση 3ου Πεδίου (Δευτ. Συστατικό)',
        'vv_quiz_status_callback',
        'vapevida-quiz-details',
        'vv_quiz_main_section'
    );
    
    // 2. Field Label: Primary Dropdown Placeholder
    add_settings_field(
        'placeholder_primary',
        'Placeholder Βασικού Συστατικού',
        'vv_quiz_text_field_callback',
        'vapevida-quiz-details',
        'vv_quiz_main_section',
        ['field_id' => 'placeholder_primary', 'default' => '-- Επιλογή Βασικού Συστατικού --']
    );

    // 3. Field Label: Secondary Dropdown Placeholder
    add_settings_field(
        'placeholder_secondary',
        'Placeholder Δευτερεύοντος Συστατικού',
        'vv_quiz_text_field_callback',
        'vapevida-quiz-details',
        'vv_quiz_main_section',
        ['field_id' => 'placeholder_secondary', 'default' => '-- Επιλογή Δευτερεύον Συστατικού --']
    );
}
add_action( 'admin_init', 'vv_quiz_register_settings' );


// --- 9. Callbacks for Settings Fields ---

// Main section header text
function vv_quiz_main_section_callback() {
    echo '<p>Εδώ ορίζετε τις ετικέτες και τη δομή του Quiz που εμφανίζεται στην Αρχική Σελίδα.</p>';
}

// Callback for Checkbox (Status) field
function vv_quiz_status_callback() {
    $options = get_option( 'vv_quiz_settings' );
    $checked = isset( $options['field_status'] ) ? $options['field_status'] : false;
    echo '<input type="checkbox" name="vv_quiz_settings[field_status]" value="1" ' . checked( 1, $checked, false ) . ' />';
    echo '<label for="vv_quiz_settings[field_status]">Εμφάνιση/Απόκρυψη του 3ου πεδίου στη φόρμα του Quiz.</label>';
}

// Callback for Text Input fields (Placeholders)
function vv_quiz_text_field_callback( $args ) {
    $options = get_option( 'vv_quiz_settings' );
    $field_id = $args['field_id'];
    $default_value = $args['default'];
    $current_value = isset( $options[$field_id] ) ? $options[$field_id] : $default_value;

    echo '<input type="text" id="' . esc_attr($field_id) . '" name="vv_quiz_settings[' . esc_attr($field_id) . ']" value="' . esc_attr( $current_value ) . '" class="regular-text" placeholder="' . esc_attr($default_value) . '" />';
}